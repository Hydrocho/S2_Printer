<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>S2 Mini ë¼ë²¨ í”„ë¦°í„°</title>
    <style>
        body { font-family: -apple-system, sans-serif; padding: 20px; text-align: center; background: #f8f9fa; }
        
        button, label { 
            display: block;
            padding: 16px 0; 
            width: 100%; 
            margin: 12px 0; 
            font-size: 17px; 
            border-radius: 12px; 
            border: none; 
            font-weight: 600; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: transform 0.1s;
        }
        button:active { transform: scale(0.98); }

        .btn-connect { background: #007bff; color: white; }
        .btn-select { background: #495057; color: white; }
        .btn-print { background: #28a745; color: white; }
        .btn-align { background: #ffc107; color: #333; } /* ë…¸ë€ìƒ‰ ì •ë ¬ ë²„íŠ¼ */
        .btn-print:disabled { background: #ccc; }

        #status { font-size: 14px; color: #555; margin: 10px 0; min-height: 20px;}
        
        /* ìº”ë²„ìŠ¤ (ìˆ¨ê¹€) */
        canvas { display: none; }
        /* ë¯¸ë¦¬ë³´ê¸° ì´ë¯¸ì§€ ìŠ¤íƒ€ì¼ */
        #preview-container { margin: 20px auto; border: 2px dashed #ccc; padding: 10px; max-width: 384px; min-height: 100px; border-radius: 10px;}
        #preview-img { width: 100%; filter: grayscale(100%); display: none;}
    </style>
</head>
<body>

    <h2>S2 Mini ë¼ë²¨ í”„ë¦°í„°</h2>
    <div id="status">ì¤€ë¹„ ì™„ë£Œ. í”„ë¦°í„°ë¥¼ ì—°ê²°í•˜ì„¸ìš”.</div>

    <button class="btn-connect" onclick="connectByService()">ğŸ”µ 1. í”„ë¦°í„° ì—°ê²°í•˜ê¸°</button>

    <button class="btn-align" onclick="alignLabel()" id="alignBtn" disabled>ğŸ“ ë¼ë²¨ ìœ„ì¹˜ ì¡ê¸° (Gap)</button>

    <label class="btn-select" id="fileLabel" style="display:none;">
        ğŸ“· 2. ì‚¬ì§„ ì„ íƒí•˜ê¸°
        <input type="file" id="imageInput" accept="image/*" style="display: none;" onchange="loadImage()">
    </label>

    <div id="preview-container">
        <div id="preview-text" style="color:#aaa; padding-top: 30px;">ì‚¬ì§„ì„ ì„ íƒí•˜ë©´<br>ì—¬ê¸°ì— ë¯¸ë¦¬ë³´ê¸°ê°€ ëœ¹ë‹ˆë‹¤.</div>
        <img id="preview-img">
    </div>

    <button id="printBtn" class="btn-print" onclick="printImage()" disabled>ğŸ–¨ï¸ 3. ì¸ì‡„ ì‹œì‘</button>

    <canvas id="canvas"></canvas>

    <script>
        let printCharacteristic = null;
        const PRINTER_WIDTH = 384; 

        // 1. ì—°ê²° í•¨ìˆ˜
        async function connectByService() {
            try {
                updateStatus("ğŸ“¡ í”„ë¦°í„° ì°¾ëŠ” ì¤‘...");
                const device = await navigator.bluetooth.requestDevice({
                    filters: [{ services: [0x18f0] }] 
                });

                const server = await device.gatt.connect();
                const service = await server.getPrimaryService(0x18f0);
                printCharacteristic = await service.getCharacteristic(0x2af1);

                updateStatus("âœ… ì—°ê²° ì„±ê³µ!");
                
                // ë²„íŠ¼ í™œì„±í™”
                document.querySelector('.btn-connect').style.display = 'none';
                document.getElementById('fileLabel').style.display = 'block';
                document.getElementById('alignBtn').disabled = false;
                
            } catch (error) {
                updateStatus("âŒ ì—°ê²° ì‹¤íŒ¨: " + error);
            }
        }

        // [ìƒˆ ê¸°ëŠ¥] ë¼ë²¨ ì •ë ¬ (Form Feed)
        async function alignLabel() {
            if (!printCharacteristic) return;
            updateStatus("ğŸ“ ë¼ë²¨ ìœ„ì¹˜ë¥¼ ì¡ëŠ” ì¤‘...");
            try {
                // 0x0CëŠ” í‘œì¤€ 'Form Feed'(ë‹¤ìŒ í˜ì´ì§€ë¡œ ì´ë™) ëª…ë ¹ì–´ì…ë‹ˆë‹¤.
                // ë¼ë²¨ í”„ë¦°í„°ëŠ” ì´ ì‹ í˜¸ë¥¼ ë°›ìœ¼ë©´ ë‹¤ìŒ ê°­(Gap)ê¹Œì§€ ì¢…ì´ë¥¼ ë°‰ë‹ˆë‹¤.
                await printCharacteristic.writeValue(new Uint8Array([0x0C]));
                
                // ë§Œì•½ ìœ„ ëª…ë ¹ì–´ê°€ ì•ˆ ë¨¹íˆë©´, ê°•ì œë¡œ ì¡°ê¸ˆ ë°€ì–´ì£¼ëŠ” ì½”ë“œë¡œ ëŒ€ì²´ ê°€ëŠ¥:
                // await printCharacteristic.writeValue(new Uint8Array([0x1B, 0x4A, 150])); 
                
                updateStatus("âœ… ì •ë ¬ ëª…ë ¹ ì „ì†¡ ì™„ë£Œ");
            } catch (e) {
                updateStatus("âŒ ì •ë ¬ ì‹¤íŒ¨: " + e);
            }
        }

        // 2. ì´ë¯¸ì§€ ì²˜ë¦¬
        function loadImage() {
            const input = document.getElementById('imageInput');
            if (!input.files || !input.files[0]) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    processImage(img);
                };
                img.src = e.target.result;
                
                // ë¯¸ë¦¬ë³´ê¸° í‘œì‹œ
                const previewImg = document.getElementById('preview-img');
                previewImg.src = e.target.result;
                previewImg.style.display = 'block';
                document.getElementById('preview-text').style.display = 'none';
            };
            reader.readAsDataURL(input.files[0]);
        }

        function processImage(img) {
            const canvas = document.getElementById('canvas');
            const ctx = canvas.getContext('2d');

            const scale = PRINTER_WIDTH / img.width;
            const height = img.height * scale;

            canvas.width = PRINTER_WIDTH;
            canvas.height = height;

            ctx.fillStyle = 'white';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(img, 0, 0, PRINTER_WIDTH, height);

            const imgData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imgData.data;

            // í‘ë°± ë³€í™˜ (ì´ì§„í™”)
            for (let i = 0; i < data.length; i += 4) {
                const avg = (data[i] + data[i + 1] + data[i + 2]) / 3;
                const color = avg < 128 ? 0 : 255;
                data[i] = data[i + 1] = data[i + 2] = color;
            }
            ctx.putImageData(imgData, 0, 0);

            document.getElementById('printBtn').disabled = false;
            updateStatus("ì¸ì‡„ ì¤€ë¹„ ì™„ë£Œ.");
        }

        // 3. ì¸ì‡„ ë° ìë™ ë°°ì¶œ
        async function printImage() {
            if (!printCharacteristic) return;
            
            const canvas = document.getElementById('canvas');
            const ctx = canvas.getContext('2d');
            const imgData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            
            const widthBytes = PRINTER_WIDTH / 8; 
            const height = canvas.height;

            updateStatus("ğŸ–¨ï¸ ì¸ì‡„ ì¤‘...");

            // ì´ë¯¸ì§€ ë°ì´í„° ì „ì†¡
            for (let y = 0; y < height; y++) {
                let cmd = [0x1D, 0x76, 0x30, 0x00, widthBytes, 0x00, 0x01, 0x00];
                let lineData = [];

                for (let x = 0; x < PRINTER_WIDTH; x += 8) {
                    let byte = 0;
                    for (let b = 0; b < 8; b++) {
                        const pixelIndex = ((y * PRINTER_WIDTH) + (x + b)) * 4;
                        if (imgData.data[pixelIndex] === 0) {
                            byte |= (1 << (7 - b));
                        }
                    }
                    lineData.push(byte);
                }
                
                let packet = new Uint8Array(cmd.concat(lineData));
                await printCharacteristic.writeValue(packet);
            }

            // [í•µì‹¬] ì¸ì‡„ í›„ ì—¬ë°± ë°€ì–´ë‚´ê¸° (Padding)
            // ì´ë¯¸ì§€ë¥¼ ë‹¤ ë½‘ì€ ë’¤, ì¹¼ë‚  ìœ„ì¹˜ê¹Œì§€ ì¢…ì´ë¥¼ ì­ˆìš± ë°€ì–´ì¤ë‹ˆë‹¤.
            // 0x1B 0x4A 0xFF (255ë§Œí¼ ë°€ê¸° - ì•½ 3cm)
            updateStatus("âœ‚ï¸ ë°°ì¶œ ì¤‘...");
            const feed = new Uint8Array([0x1B, 0x4A, 0xFF]); 
            await printCharacteristic.writeValue(feed);
            
            // í•œ ë²ˆ ë” ë°€ì–´ì„œ í™•ì‹¤í•˜ê²Œ (í•„ìš” ì‹œ ì£¼ì„ í•´ì œ)
            // await printCharacteristic.writeValue(feed);

            updateStatus("ğŸ‰ ì¸ì‡„ ì™„ë£Œ! ëœ¯ìœ¼ì„¸ìš”.");
        }

        function updateStatus(msg) {
            document.getElementById('status').innerText = msg;
        }
    </script>
</body>
</html>
