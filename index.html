<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>S2 Mini ìµœì¢… ì—°ê²°</title>
    <style>
        body { font-family: -apple-system, sans-serif; padding: 20px; text-align: center; background: #eee; }
        button { padding: 20px; width: 100%; margin: 10px 0; font-size: 18px; border-radius: 15px; border: none; font-weight: bold; box-shadow: 0 5px 10px rgba(0,0,0,0.1); }
        .btn-connect { background: #007aff; color: white; }
        .btn-print { background: #34c759; color: white; }
        .log-box { background: #000; color: #0f0; padding: 15px; border-radius: 10px; text-align: left; height: 200px; overflow-y: scroll; font-size: 13px; font-family: monospace; }
    </style>
</head>
<body>

    <h2>S2 Mini ìµœì¢… ì—°ê²°</h2>
    <p>ì•„ì´í° ì¬ë¶€íŒ… í›„ ì‹œë„í•´ì£¼ì„¸ìš”.</p>

    <button class="btn-connect" onclick="connectByService()">ğŸ¯ í”„ë¦°í„° ì°¾ê¸° (ì„œë¹„ìŠ¤ID)</button>
    <button id="printBtn" class="btn-print" onclick="printTest()" disabled>ğŸ–¨ï¸ ì¢…ì´ ë°€ê¸°</button>

    <div id="log-area" class="log-box">ëŒ€ê¸° ì¤‘...</div>

    <script>
        let printCharacteristic = null;

        function log(msg) {
            const box = document.getElementById('log-area');
            const time = new Date().toLocaleTimeString().split(' ')[0];
            box.innerHTML = `[${time}] ${msg}<br>` + box.innerHTML;
        }

        async function connectByService() {
            if (!navigator.bluetooth) {
                log("âŒ Bluefy ì•±ì´ ì•„ë‹™ë‹ˆë‹¤.");
                return;
            }

            try {
                log("ğŸ“¡ í”„ë¦°í„° ì‹ í˜¸(0x18F0) ìŠ¤ìº” ì¤‘...");
                
                // [ìµœì¢… ë°©ë²•] ì´ë¦„ í•„í„° ë‹¤ ë¹¼ê³ , ì˜¤ì§ 'ì„œë¹„ìŠ¤ ID'ë¡œë§Œ ì°¾ìŠµë‹ˆë‹¤.
                // ì´ ë°©ë²•ì´ ê°€ì¥ ì •í™•í•©ë‹ˆë‹¤.
                const device = await navigator.bluetooth.requestDevice({
                    filters: [{ services: [0x18f0] }] 
                });

                log(`âœ… ê¸°ê¸° ë°œê²¬: ${device.name}`);
                
                device.addEventListener('gattserverdisconnected', () => {
                    log("âš ï¸ ì—°ê²° ëŠê¹€");
                    document.getElementById('printBtn').disabled = true;
                });

                log("ì—°ê²° ì‹œë„ ì¤‘...");
                const server = await device.gatt.connect();
                
                log("ì„œë¹„ìŠ¤ ì¸ì¦ ì¤‘...");
                const service = await server.getPrimaryService(0x18f0);
                
                log("ì“°ê¸° ê¶Œí•œ í™•ë³´ ì¤‘...");
                printCharacteristic = await service.getCharacteristic(0x2af1);

                log("ğŸ‰ ì—°ê²° ì„±ê³µ! ë²„íŠ¼ì´ í™œì„±í™”ë©ë‹ˆë‹¤.");
                document.getElementById('printBtn').disabled = false;

            } catch (error) {
                log(`âŒ ì‹¤íŒ¨: ${error}`);
                log("ğŸ‘‰ íŒ: ì•„ì´í°ì„ ê»ë‹¤ ì¼œì…¨ë‚˜ìš”?");
            }
        }

        async function printTest() {
            if (!printCharacteristic) return;
            try {
                // ì¢…ì´ ë°€ê¸° (Feed)
                const data = new Uint8Array([0x1B, 0x4A, 100]);
                await printCharacteristic.writeValue(data);
                log("ğŸ“¤ ì „ì†¡ ì™„ë£Œ!");
            } catch (error) {
                log(`âŒ ì „ì†¡ ì‹¤íŒ¨: ${error}`);
            }
        }
    </script>
</body>
</html>
