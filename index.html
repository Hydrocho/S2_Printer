<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>S2 Mini í”„ë¦°í„° ì—°ê²° (ìˆ˜ì •íŒ)</title>
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            padding: 20px; 
            text-align: center; 
            background-color: #f4f4f4;
        }
        h2 { color: #333; }
        p { color: #666; margin-bottom: 30px; }
        
        button { 
            padding: 15px 0; 
            font-size: 18px; 
            font-weight: bold;
            margin: 10px 0; 
            width: 100%; 
            max-width: 300px;
            border-radius: 12px; 
            border: none; 
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: transform 0.1s;
        }
        button:active { transform: scale(0.98); }
        
        .btn-connect { background-color: #007bff; color: white; }
        .btn-print { background-color: #28a745; color: white; }
        .btn-print:disabled { background-color: #ccc; }

        /* ë¡œê·¸ ì°½ ìŠ¤íƒ€ì¼ */
        #log-area {
            margin-top: 20px;
            padding: 15px;
            background: #fff;
            border-radius: 10px;
            border: 1px solid #ddd;
            text-align: left;
            height: 200px;
            overflow-y: auto;
            font-size: 12px;
            font-family: monospace;
            color: #333;
        }
        .log-entry { border-bottom: 1px solid #eee; padding: 2px 0; }
        .error { color: red; font-weight: bold; }
        .success { color: green; font-weight: bold; }
    </style>
</head>
<body>

    <h2>S2 Mini ì—°ê²° í…ŒìŠ¤íŠ¸</h2>
    <p>ë°˜ë“œì‹œ <b>Bluefy ì•±</b>ìœ¼ë¡œ ì ‘ì†í•´ì£¼ì„¸ìš”.</p>

    <button class="btn-connect" onclick="connectToPrinter()">ğŸ”µ ì¥ì¹˜ ì°¾ê¸° & ì—°ê²°</button>
    <br>
    <button id="printBtn" class="btn-print" onclick="printTest()" disabled>ğŸ–¨ï¸ í…ŒìŠ¤íŠ¸ (ì¢…ì´ ë°€ê¸°)</button>

    <div id="log-area">
        <div class="log-entry">ëŒ€ê¸° ì¤‘... ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.</div>
    </div>

    <script>
        let printCharacteristic = null;
        let printDevice = null;

        // í™”ë©´ì— ë¡œê·¸ë¥¼ ì°ëŠ” í•¨ìˆ˜
        function log(message, type = 'normal') {
            const logArea = document.getElementById('log-area');
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            if (type === 'error') entry.className += ' error';
            if (type === 'success') entry.className += ' success';
            
            const time = new Date().toLocaleTimeString();
            entry.innerText = `[${time}] ${message}`;
            
            logArea.prepend(entry); // ìµœì‹  ë¡œê·¸ê°€ ìœ„ë¡œ ì˜¤ê²Œ
        }

        // 1. ì—°ê²° í•¨ìˆ˜
        async function connectToPrinter() {
            // ë¸Œë¼ìš°ì € í˜¸í™˜ì„± ì²´í¬
            if (!navigator.bluetooth) {
                log("âŒ ì´ ë¸Œë¼ìš°ì €ëŠ” ë¸”ë£¨íˆ¬ìŠ¤ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ì•„ì´í°ì´ë¼ë©´ 'Bluefy' ì•±ì„ ì‚¬ìš©í•˜ì„¸ìš”.", 'error');
                return;
            }

            try {
                log("ì¥ì¹˜ ê²€ìƒ‰ì„ ì‹œì‘í•©ë‹ˆë‹¤...");
                
                // [ì¤‘ìš”] í•„í„° ì—†ì´ ëª¨ë“  ê¸°ê¸°ë¥¼ ê²€ìƒ‰í•©ë‹ˆë‹¤.
                // optionalServicesì— 0x18f0ì„ ê¼­ ë„£ì–´ì•¼ ë‚˜ì¤‘ì— ì ‘ê·¼ ê¶Œí•œì´ ìƒê¹ë‹ˆë‹¤.
                const device = await navigator.bluetooth.requestDevice({
                    acceptAllDevices: true, 
                    optionalServices: [0x18f0] 
                });

                printDevice = device;
                log(`ê¸°ê¸° ì„ íƒë¨: ${device.name}`);
                
                // ì—°ê²° ëŠê¹€ ê°ì§€ ë¦¬ìŠ¤ë„ˆ
                device.addEventListener('gattserverdisconnected', onDisconnected);

                log("GATT ì„œë²„ì— ì—°ê²° ì‹œë„ ì¤‘...");
                const server = await device.gatt.connect();
                
                log("ì„œë¹„ìŠ¤(0x18F0) ì°¾ëŠ” ì¤‘...");
                const service = await server.getPrimaryService(0x18f0);
                
                log("íŠ¹ì„±(0x2AF1) ì°¾ëŠ” ì¤‘...");
                printCharacteristic = await service.getCharacteristic(0x2af1);

                log("âœ… ì—°ê²° ì„±ê³µ! ì´ì œ ì¸ì‡„ ê°€ëŠ¥í•©ë‹ˆë‹¤.", 'success');
                document.getElementById('printBtn').disabled = false;
                document.getElementById('printBtn').innerText = "ğŸ–¨ï¸ í…ŒìŠ¤íŠ¸ (ì¢…ì´ ë°€ê¸°)";

            } catch (error) {
                log("âŒ ì—°ê²° ì‹¤íŒ¨: " + error, 'error');
                console.error(error);
            }
        }

        // 2. ì—°ê²° ëŠê¹€ ì²˜ë¦¬
        function onDisconnected(event) {
            log("âš ï¸ ì—°ê²°ì´ ëŠì–´ì¡ŒìŠµë‹ˆë‹¤.", 'error');
            document.getElementById('printBtn').disabled = true;
            printCharacteristic = null;
        }

        // 3. í…ŒìŠ¤íŠ¸ ì¸ì‡„ (Feed)
        async function printTest() {
            if (!printCharacteristic) {
                log("ì—°ê²°ì´ ë˜ì–´ìˆì§€ ì•ŠìŠµë‹ˆë‹¤.", 'error');
                return;
            }

            try {
                log("ë°ì´í„° ì „ì†¡ ì¤‘...");
                
                // S2 Miniìš© Feed ëª…ë ¹ì–´ (ESC J n)
                // 0x1B(ESC) 0x4A(J) 0x40(64ë§Œí¼ ì´ë™)
                const data = new Uint8Array([0x1B, 0x4A, 0x64]);
                
                await printCharacteristic.writeValue(data);
                log("âœ… ì „ì†¡ ì™„ë£Œ! (ë°˜ì‘ì´ ìˆë‚˜ìš”?)", 'success');
                
            } catch (error) {
                log("âŒ ì „ì†¡ ì‹¤íŒ¨: " + error, 'error');
            }
        }
    </script>
</body>
</html>
