<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>S2 Mini í¬í†  í”„ë¦°í„°</title>
    <style>
        body { font-family: -apple-system, sans-serif; padding: 20px; text-align: center; background: #f8f9fa; }
        h2 { margin-bottom: 10px; }
        
        /* ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        button, label { 
            display: block;
            padding: 15px 0; 
            width: 100%; 
            margin: 10px 0; 
            font-size: 16px; 
            border-radius: 12px; 
            border: none; 
            font-weight: bold; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            cursor: pointer;
        }
        .btn-connect { background: #007bff; color: white; }
        .btn-select { background: #6c757d; color: white; }
        .btn-print { background: #28a745; color: white; }
        .btn-print:disabled { background: #ccc; }

        #status { font-size: 14px; color: #555; margin: 10px 0; min-height: 20px;}
        
        /* ë¯¸ë¦¬ë³´ê¸° ìº”ë²„ìŠ¤ (ìˆ¨ê¹€) */
        canvas { border: 1px solid #ddd; margin-top: 10px; max-width: 100%; display: none; }
        #preview { display: block; margin: 0 auto; filter: grayscale(100%); }
    </style>
</head>
<body>

    <h2>S2 Mini í¬í†  í”„ë¦°í„°</h2>
    <div id="status">ì¤€ë¹„ ì™„ë£Œ. í”„ë¦°í„°ë¥¼ ì—°ê²°í•˜ì„¸ìš”.</div>

    <button class="btn-connect" onclick="connectByService()">ğŸ”µ 1. í”„ë¦°í„° ì—°ê²°í•˜ê¸°</button>

    <label class="btn-select" id="fileLabel" style="display:none;">
        ğŸ“· 2. ì‚¬ì§„ ì„ íƒí•˜ê¸°
        <input type="file" id="imageInput" accept="image/*" style="display: none;" onchange="loadImage()">
    </label>

    <button id="printBtn" class="btn-print" onclick="printImage()" disabled>ğŸ–¨ï¸ 3. ì¸ì‡„ ì‹œì‘</button>

    <canvas id="canvas"></canvas>

    <script>
        let printCharacteristic = null;
        const PRINTER_WIDTH = 384; // S2 Miniì˜ ê°€ë¡œ í”½ì…€ í­ (ê³ ì •)

        // 1. í”„ë¦°í„° ì—°ê²° (ì•„ê¹Œ ì„±ê³µí•œ ê·¸ ì½”ë“œ)
        async function connectByService() {
            try {
                updateStatus("ğŸ“¡ í”„ë¦°í„° ì°¾ëŠ” ì¤‘...");
                const device = await navigator.bluetooth.requestDevice({
                    filters: [{ services: [0x18f0] }] 
                });

                updateStatus("ì—°ê²° ì‹œë„ ì¤‘...");
                const server = await device.gatt.connect();
                const service = await server.getPrimaryService(0x18f0);
                printCharacteristic = await service.getCharacteristic(0x2af1);

                updateStatus("âœ… ì—°ê²° ì„±ê³µ! ì‚¬ì§„ì„ ì„ íƒí•˜ì„¸ìš”.");
                
                // UI í™œì„±í™”
                document.querySelector('.btn-connect').style.display = 'none';
                document.getElementById('fileLabel').style.display = 'block';
                
            } catch (error) {
                updateStatus("âŒ ì—°ê²° ì‹¤íŒ¨: " + error);
            }
        }

        // 2. ì´ë¯¸ì§€ ë¶ˆëŸ¬ì˜¤ê¸° ë° í‘ë°± ë³€í™˜
        function loadImage() {
            const input = document.getElementById('imageInput');
            if (!input.files || !input.files[0]) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    processImage(img);
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(input.files[0]);
        }

        function processImage(img) {
            const canvas = document.getElementById('canvas');
            const ctx = canvas.getContext('2d');

            // ë¹„ìœ¨ ìœ ì§€í•˜ë©´ì„œ ë„ˆë¹„ë¥¼ 384pxë¡œ ì¡°ì •
            const scale = PRINTER_WIDTH / img.width;
            const height = img.height * scale;

            canvas.width = PRINTER_WIDTH;
            canvas.height = height;
            canvas.style.display = 'block';

            // í°ìƒ‰ ë°°ê²½ ê¹”ê¸° (íˆ¬ëª… ì´ë¯¸ì§€ ëŒ€ì‘)
            ctx.fillStyle = 'white';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(img, 0, 0, PRINTER_WIDTH, height);

            // í‘ë°± ë³€í™˜ (ì´ì§„í™”)
            const imgData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imgData.data;

            for (let i = 0; i < data.length; i += 4) {
                // ë°ê¸° ê³„ì‚°
                const avg = (data[i] + data[i + 1] + data[i + 2]) / 3;
                // ê¸°ì¤€ë³´ë‹¤ ì–´ë‘ìš°ë©´ ê²€ì •(0), ë°ìœ¼ë©´ í°ìƒ‰(255)
                const color = avg < 128 ? 0 : 255;
                data[i] = data[i + 1] = data[i + 2] = color;
            }
            ctx.putImageData(imgData, 0, 0);

            // ì¸ì‡„ ë²„íŠ¼ í™œì„±í™”
            document.getElementById('printBtn').disabled = false;
            updateStatus("ì´ë¯¸ì§€ ì¤€ë¹„ ì™„ë£Œ. ì¸ì‡„ ë²„íŠ¼ì„ ëˆ„ë¥´ì„¸ìš”.");
        }

        // 3. ì‹¤ì œ ì¸ì‡„ (ë°ì´í„° ì „ì†¡)
        async function printImage() {
            if (!printCharacteristic) return;
            
            const canvas = document.getElementById('canvas');
            const ctx = canvas.getContext('2d');
            const imgData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            
            // GS v 0 (ë˜ìŠ¤í„° ë¹„íŠ¸ ì´ë¯¸ì§€ ì¸ì‡„ ëª…ë ¹)
            // í¬ë§·: 0x1D 0x76 0x30 0x00 (xL xH) (yL yH) [ë°ì´í„°...]
            const widthBytes = PRINTER_WIDTH / 8; // 48 bytes
            const height = canvas.height;

            updateStatus("ğŸ–¨ï¸ ë°ì´í„° ì „ì†¡ ì¤‘... ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.");

            // ë°ì´í„° íŒ¨í‚· ìƒì„±
            // ì°¸ê³ : í•œ ë²ˆì— ë„ˆë¬´ ë§ì´ ë³´ë‚´ë©´ ëŠê¸°ë¯€ë¡œ í•œ ì¤„ì”© ë³´ëƒ…ë‹ˆë‹¤.
            for (let y = 0; y < height; y++) {
                
                // 1. í—¤ë” (GS v 0 ...)
                // ë†’ì´ 1ì¤„ì”© ìª¼ê°œì„œ ë³´ëƒ…ë‹ˆë‹¤.
                let cmd = [0x1D, 0x76, 0x30, 0x00, widthBytes, 0x00, 0x01, 0x00];
                let lineData = [];

                // 2. í”½ì…€ ë°ì´í„° ë¹„íŠ¸ íŒ¨í‚¹ (8ê°œë¥¼ 1ë°”ì´íŠ¸ë¡œ ì••ì¶•)
                for (let x = 0; x < PRINTER_WIDTH; x += 8) {
                    let byte = 0;
                    for (let b = 0; b < 8; b++) {
                        // ê²€ì •ìƒ‰(0)ì´ë©´ ë¹„íŠ¸ë¥¼ 1ë¡œ ì„¤ì • (í”„ë¦°í„°ëŠ” 1ì´ ì¸ì‡„ì„)
                        const pixelIndex = ((y * PRINTER_WIDTH) + (x + b)) * 4;
                        if (imgData.data[pixelIndex] === 0) {
                            byte |= (1 << (7 - b));
                        }
                    }
                    lineData.push(byte);
                }

                // ëª…ë ¹ì–´ + ë°ì´í„° í•©ì¹˜ê¸°
                let packet = new Uint8Array(cmd.concat(lineData));
                
                // ë¸”ë£¨íˆ¬ìŠ¤ë¡œ ì „ì†¡
                await printCharacteristic.writeValue(packet);
                
                // ë„ˆë¬´ ë¹ ë¥´ë©´ ê¼¬ì¼ ìˆ˜ ìˆìœ¼ë‹ˆ ì•½ê°„ì˜ ë”œë ˆì´
                // await new Promise(r => setTimeout(r, 10)); 
            }

            // ë‹¤ ì°ê³  ë‚˜ë©´ ì¢…ì´ ì¢€ ë°€ì–´ì£¼ê¸° (Feed 3ì¤„)
            const feed = new Uint8Array([0x1B, 0x4A, 100]);
            await printCharacteristic.writeValue(feed);
            
            updateStatus("ğŸ‰ ì¸ì‡„ ì™„ë£Œ!");
        }

        function updateStatus(msg) {
            document.getElementById('status').innerText = msg;
        }
    </script>
</body>
</html>
