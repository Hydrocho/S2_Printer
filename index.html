<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>S2 Mini í”„ë¦°í„° (ì „ì²´ ê²€ìƒ‰)</title>
    <style>
        body { 
            font-family: -apple-system, sans-serif; 
            padding: 20px; 
            text-align: center; 
            background-color: #f4f4f4;
        }
        button { 
            padding: 15px 0; 
            font-size: 18px; 
            margin: 10px 0; 
            width: 100%; 
            border-radius: 12px; 
            border: none; 
            font-weight: bold;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .btn-connect { background-color: #007bff; color: white; }
        .btn-print { background-color: #28a745; color: white; }
        .btn-print:disabled { background-color: #ccc; }
        
        #log-area {
            margin-top: 20px;
            padding: 10px;
            background: #222;
            color: #0f0;
            border-radius: 8px;
            text-align: left;
            height: 200px;
            overflow-y: auto;
            font-size: 12px;
            font-family: monospace;
        }
    </style>
</head>
<body>

    <h2>ëª¨ë“  ê¸°ê¸° ê²€ìƒ‰ ëª¨ë“œ</h2>
    <p>ëª©ë¡ì´ ëœ¨ë©´ <b>S2-1B71</b>ì„ ì„ íƒí•˜ì„¸ìš”.</p>

    <button class="btn-connect" onclick="connectToPrinter()">ğŸ” ì£¼ë³€ ê¸°ê¸° ì „ì²´ ê²€ìƒ‰</button>
    <button id="printBtn" class="btn-print" onclick="printTest()" disabled>ğŸ–¨ï¸ ì—°ê²° í›„ í…ŒìŠ¤íŠ¸</button>

    <div id="log-area">ëŒ€ê¸° ì¤‘...</div>

    <script>
        let printCharacteristic = null;

        function log(msg) {
            const box = document.getElementById('log-area');
            const time = new Date().toLocaleTimeString().split(' ')[0];
            box.innerHTML = `[${time}] ${msg}<br>` + box.innerHTML;
        }

        async function connectToPrinter() {
            if (!navigator.bluetooth) {
                log("âŒ Bluefy ì•±ìœ¼ë¡œ ì ‘ì†í•´ì£¼ì„¸ìš”.");
                return;
            }

            try {
                log("ğŸ” ì£¼ë³€ì˜ ëª¨ë“  ê¸°ê¸°ë¥¼ ê²€ìƒ‰í•©ë‹ˆë‹¤...");
                
                // [ìˆ˜ì •ë¨] í•„í„° ì—†ì´ ëª¨ë“  ê¸°ê¸° í—ˆìš© (acceptAllDevices: true)
                // ë‹¨, S2 í”„ë¦°í„°ì™€ í†µì‹ í•˜ë ¤ë©´ optionalServicesëŠ” ê¼­ ìˆì–´ì•¼ í•©ë‹ˆë‹¤.
                const device = await navigator.bluetooth.requestDevice({
                    acceptAllDevices: true,
                    optionalServices: [0x18f0] 
                });

                log(`ğŸ‘‰ ì„ íƒëœ ê¸°ê¸°: ${device.name}`);
                
                device.addEventListener('gattserverdisconnected', () => {
                    log("âš ï¸ ì—°ê²°ì´ ëŠì–´ì¡ŒìŠµë‹ˆë‹¤.");
                    document.getElementById('printBtn').disabled = true;
                });

                log("ì—°ê²° ì‹œë„ ì¤‘...");
                const server = await device.gatt.connect();
                
                log("ì„œë¹„ìŠ¤(0x18F0) ì°¾ëŠ” ì¤‘...");
                const service = await server.getPrimaryService(0x18f0);
                
                log("í†µì‹  ì±„ë„(0x2AF1) ì—°ê²° ì¤‘...");
                printCharacteristic = await service.getCharacteristic(0x2af1);

                log("âœ… ì—°ê²° ì„±ê³µ! í…ŒìŠ¤íŠ¸ ë²„íŠ¼ì„ ëˆ„ë¥´ì„¸ìš”.");
                document.getElementById('printBtn').disabled = false;

            } catch (error) {
                log(`âŒ ì—ëŸ¬: ${error}`);
            }
        }

        async function printTest() {
            if (!printCharacteristic) return;
            try {
                // ì¢…ì´ ë°€ê¸° ëª…ë ¹ì–´ (Feed)
                const data = new Uint8Array([0x1B, 0x4A, 100]);
                await printCharacteristic.writeValue(data);
                log("ğŸ“¤ ì „ì†¡ ì™„ë£Œ!");
            } catch (error) {
                log(`âŒ ì „ì†¡ ì‹¤íŒ¨: ${error}`);
            }
        }
    </script>
</body>
</html>
