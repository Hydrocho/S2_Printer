<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>S2 Mini í”„ë¦°í„° ì—°ê²° (í•„í„° ìˆ˜ì •íŒ)</title>
    <style>
        /* ê¹”ë”í•œ ëª¨ë°”ì¼ UI ìŠ¤íƒ€ì¼ */
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            padding: 20px; 
            text-align: center; 
            background-color: #f8f9fa;
        }
        h2 { color: #333; margin-bottom: 10px; }
        .guide { 
            background: #e9ecef; 
            padding: 10px; 
            border-radius: 8px; 
            font-size: 14px; 
            color: #555; 
            margin-bottom: 20px;
            text-align: left;
        }
        
        /* ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        button { 
            padding: 16px 0; 
            font-size: 17px; 
            font-weight: 600;
            margin: 8px 0; 
            width: 100%; 
            border-radius: 12px; 
            border: none; 
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: all 0.2s;
        }
        button:active { transform: scale(0.96); }
        
        .btn-connect { background-color: #007bff; color: white; }
        .btn-print { background-color: #28a745; color: white; }
        .btn-print:disabled { background-color: #cbd3da; cursor: not-allowed; }

        /* ë¡œê·¸ ì°½ ìŠ¤íƒ€ì¼ */
        #log-area {
            margin-top: 20px;
            padding: 15px;
            background: #212529;
            color: #00ff00;
            border-radius: 10px;
            text-align: left;
            height: 250px;
            overflow-y: auto;
            font-size: 12px;
            font-family: 'Courier New', monospace;
            line-height: 1.5;
        }
        .log-time { color: #888; margin-right: 5px; }
        .log-error { color: #ff6b6b; font-weight: bold; }
    </style>
</head>
<body>

    <h2>S2 Mini ì—°ê²° í…ŒìŠ¤íŠ¸</h2>

    <div class="guide">
        <b>ğŸ’¡ ì—°ê²° ì „ í•„ìˆ˜ í™•ì¸:</b><br>
        1. ì•„ì´í° ì„¤ì • > ë¸”ë£¨íˆ¬ìŠ¤ > S2-1B71 <b>[ì´ ê¸°ê¸° ì§€ìš°ê¸°]</b> í•„ìˆ˜!<br>
        2. ë‹¤ë¥¸ ì•±(LightBlue ë“±) ì™„ì „íˆ ì¢…ë£Œ.<br>
        3. í”„ë¦°í„° ê»ë‹¤ê°€ ë‹¤ì‹œ ì¼œê¸°.
    </div>

    <button class="btn-connect" onclick="connectToPrinter()">ğŸ”µ S2 í”„ë¦°í„° ì°¾ê¸°</button>
    <button id="printBtn" class="btn-print" onclick="printTest()" disabled>ğŸ–¨ï¸ ì¢…ì´ ë°€ê¸° (Feed)</button>

    <div id="log-area">
        <div>ì¤€ë¹„ ì™„ë£Œ. [S2 í”„ë¦°í„° ì°¾ê¸°]ë¥¼ ëˆŒëŸ¬ì£¼ì„¸ìš”.</div>
    </div>

    <script>
        let printCharacteristic = null;
        let printDevice = null;

        // ë¡œê·¸ ì¶œë ¥ í•¨ìˆ˜
        function log(msg, type = 'normal') {
            const logArea = document.getElementById('log-area');
            const entry = document.createElement('div');
            const time = new Date().toLocaleTimeString('ko-KR', { hour12: false });
            
            let content = `<span class="log-time">[${time}]</span> ${msg}`;
            if (type === 'error') {
                content = `<span class="log-time">[${time}]</span> <span class="log-error">${msg}</span>`;
            }
            
            entry.innerHTML = content;
            logArea.prepend(entry); // ìµœì‹  ë¡œê·¸ê°€ ë§¨ ìœ„ì—
        }

        // 1. ì—°ê²° í•¨ìˆ˜ (í•„í„° ë°©ì‹ ë³€ê²½)
        async function connectToPrinter() {
            if (!navigator.bluetooth) {
                log("âŒ Web Bluetoothë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. Bluefy ì•±ì„ ì“°ì„¸ìš”.", 'error');
                return;
            }

            try {
                log("ğŸ” ì¥ì¹˜ ê²€ìƒ‰ ì¤‘ (ì´ë¦„: S2...)...");

                // [í•µì‹¬ ë³€ê²½] acceptAllDevices ëŒ€ì‹  filters ì‚¬ìš©
                // ë‹˜ì˜ ìŠ¤í¬ë¦°ìƒ·ì— ë‚˜ì˜¨ ì´ë¦„ 'S2'ë¡œ ì‹œì‘í•˜ëŠ” ê¸°ê¸°ë§Œ ì°¾ìŠµë‹ˆë‹¤.
                const device = await navigator.bluetooth.requestDevice({
                    filters: [
                        { namePrefix: "S2" } 
                    ],
                    optionalServices: [0x18f0] // ì„œë¹„ìŠ¤ UUID (í•„ìˆ˜)
                });

                printDevice = device;
                log(`âœ… ê¸°ê¸° ë°œê²¬: ${device.name}`);
                log("â³ GATT ì„œë²„ ì—°ê²° ì‹œë„...");

                // ì—°ê²° ëŠê¹€ ê°ì§€
                device.addEventListener('gattserverdisconnected', onDisconnected);

                const server = await device.gatt.connect();
                log("ğŸ”— ì„œë²„ ì—°ê²°ë¨. ì„œë¹„ìŠ¤(0x18F0) ì¡°íšŒ...");

                const service = await server.getPrimaryService(0x18f0);
                log("ğŸ“¦ ì„œë¹„ìŠ¤ í™•ë³´. íŠ¹ì„±(0x2AF1) ì¡°íšŒ...");

                // ìŠ¤í¬ë¦°ìƒ·ì—ì„œ í™•ì¸ëœ Write UUID
                printCharacteristic = await service.getCharacteristic(0x2af1);
                
                log("ğŸ‰ ì—°ê²° ì„±ê³µ! ì¸ì‡„ ì¤€ë¹„ ì™„ë£Œ.", 'success');
                
                // ë²„íŠ¼ í™œì„±í™”
                const btn = document.getElementById('printBtn');
                btn.disabled = false;
                btn.innerText = "ğŸ–¨ï¸ ì¢…ì´ ë°€ê¸° (Feed)";

            } catch (error) {
                log(`âŒ ì—°ê²° ì‹¤íŒ¨: ${error.message || error}`, 'error');
                
                if (error.toString().includes("cancelled")) {
                    log("ğŸ‘‰ ëª©ë¡ì—ì„œ ê¸°ê¸°ë¥¼ ì„ íƒí•˜ì§€ ì•Šê³  ì·¨ì†Œí•˜ì…¨ê±°ë‚˜, ê¸°ê¸°ê°€ ê²€ìƒ‰ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
                } else {
                    log("ğŸ‘‰ íŒ: í”„ë¦°í„° ì „ì›ì„ ê»ë‹¤ ì¼œê³  ë‹¤ì‹œ ì‹œë„í•´ë³´ì„¸ìš”.");
                }
            }
        }

        // 2. ì—°ê²° ëŠê¹€ ì²˜ë¦¬
        function onDisconnected(event) {
            log("âš ï¸ ì—°ê²°ì´ ëŠì–´ì¡ŒìŠµë‹ˆë‹¤.", 'error');
            document.getElementById('printBtn').disabled = true;
            printCharacteristic = null;
        }

        // 3. í…ŒìŠ¤íŠ¸ ëª…ë ¹ ì „ì†¡
        async function printTest() {
            if (!printCharacteristic) {
                log("âŒ ì—°ê²°ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.", 'error');
                return;
            }

            try {
                log("ğŸ“¤ ë°ì´í„° ì „ì†¡ ì¤‘ (Feed)...");
                
                // ESC J 100 (ì¢…ì´ 100ë§Œí¼ ë°€ê¸°)
                const data = new Uint8Array([0x1B, 0x4A, 100]);
                await printCharacteristic.writeValue(data);
                
                log("âœ… ì „ì†¡ ì™„ë£Œ! í”„ë¦°í„°ê°€ ë°˜ì‘í–ˆë‚˜ìš”?");
            } catch (error) {
                log(`âŒ ì „ì†¡ ì‹¤íŒ¨: ${error}`, 'error');
            }
        }
    </script>
</body>
</html>
